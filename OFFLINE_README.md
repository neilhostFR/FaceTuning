# 离线使用ModelScope皮肤美化和人像增强修复模型

本文档说明如何在断网环境下使用ModelScope的皮肤美化和人像增强修复模型。

## 步骤概述

1. 在有网络连接的环境中下载模型
2. 将模型文件复制到离线环境
3. 在离线环境中使用模型

## 详细步骤

### 1. 下载模型

在有网络连接的环境中，运行以下命令下载ModelScope的皮肤美化和人像增强修复模型：

```bash
python download_modelscope_model.py
```

这将下载两个模型并保存到以下目录：
- 皮肤美化模型：`models/iic_cv_unet_skin-retouching`
- 人像增强修复模型：`models/damo_cv_gpen_image-portrait-enhancement-hires`

如果只需要下载其中一个模型，可以使用以下命令：

```bash
# 只下载皮肤美化模型
python download_modelscope_model.py skin

# 只下载人像增强修复模型
python download_modelscope_model.py portrait
```

### 2. 复制模型文件

将整个`models`目录复制到离线环境的项目根目录下。确保目录结构如下：

```
项目根目录/
├── models/
│   ├── iic_cv_unet_skin-retouching/
│   │   ├── configuration.json
│   │   ├── model.pt
│   │   └── ... (其他模型文件)
│   └── damo_cv_gpen_image-portrait-enhancement-hires/
│       ├── configuration.json
│       ├── model.pt
│       └── ... (其他模型文件)
├── face_detection.py
├── skin_retouching.py
├── face_enhancement.py
├── gui_enhancement.py
└── ... (其他项目文件)
```

### 3. 在离线环境中使用

项目已经修改为默认使用离线模式。在离线环境中，可以直接运行以下命令：

```bash
# 使用图形界面
python gui_enhancement.py

# 或者使用命令行
python face_enhancement.py
```

## 技术说明

### 离线模式的工作原理

1. 在`SkinRetoucher`类和`FaceEnhancer`类初始化时，会检查本地是否存在已下载的模型
2. 如果找到本地模型，将使用本地模型进行处理
3. 如果未找到本地模型，会提示用户先下载模型

### 模型搜索路径

程序会按以下顺序搜索本地模型：

1. `models/iic_cv_unet_skin-retouching`（皮肤美化模型默认位置）
2. `models/damo_cv_gpen_image-portrait-enhancement-hires`（人像增强修复模型默认位置）
3. 相应的ModelScope默认缓存位置

## 功能说明

### 可选功能

在图形界面中，您可以选择启用或禁用以下功能：

1. **瘦脸功能**：通过人脸检测和变形算法，实现面部瘦脸效果。默认为禁用。
2. **皮肤美化功能**：使用ModelScope的皮肤美化模型，平滑皮肤、去除瑕疵，同时保留皮肤细节和纹理。默认为启用。
3. **人像增强功能**：使用ModelScope的人像增强修复模型，提高人像图片的清晰度和质量。默认为禁用。

**重要提示**：
- 瘦脸功能需要进行人脸检测和剪裁，如果不需要瘦脸效果，建议禁用此功能以提高处理速度
- 只有启用瘦脸功能时，程序才会进行人脸识别和剪裁操作
- 皮肤美化功能可以独立使用，不需要人脸检测
- 人像增强功能通常在皮肤美化后应用，进一步提升图片质量

### 皮肤美化

皮肤美化功能使用ModelScope的皮肤美化模型，可以平滑皮肤、去除瑕疵，同时保留皮肤细节和纹理。

**特点**：
- 自动检测皮肤区域
- 保持皮肤自然纹理
- 支持大尺寸图片处理
- 自动调整图片尺寸以优化处理效果

### 人像增强修复

人像增强修复功能使用ModelScope的人像增强修复模型，可以提高人像图片的清晰度和质量，修复模糊、低分辨率的人像图片。

**特点**：
- 提升图片清晰度
- 修复模糊和噪点
- 增强细节表现
- 自动尺寸调整和恢复

## 使用建议

### 功能组合建议

1. **仅皮肤美化**：适合只需要改善皮肤质感的场景
   - 启用：皮肤美化功能
   - 禁用：瘦脸功能、人像增强功能

2. **瘦脸 + 皮肤美化**：适合需要面部调整和皮肤改善的场景
   - 启用：瘦脸功能、皮肤美化功能
   - 禁用：人像增强功能

3. **完整处理**：适合需要最佳效果的场景
   - 启用：所有功能

### 性能优化建议

1. **提高处理速度**：
   - 禁用不需要的功能
   - 调整`max_size`参数（默认1920）
   - 使用多线程处理

2. **节省内存**：
   - 分批处理大量图片
   - 启用缓存功能
   - 定期清理临时文件

## 故障排除

### 常见问题

1. **"本地模型不存在"错误**
   - 检查是否已在有网络连接的环境中下载了模型
   - 确认模型文件已正确复制到离线环境的正确位置
   - 验证目录结构是否正确

2. **模型加载失败**
   - 检查模型文件是否完整（文件大小、文件数量）
   - 确认ModelScope库版本兼容性
   - 查看详细错误日志

3. **处理速度慢**
   - 检查系统资源使用情况
   - 调整并发处理数量
   - 考虑禁用不需要的功能

4. **内存不足**
   - 减少同时处理的图片数量
   - 降低图片处理尺寸
   - 启用垃圾回收机制

### 日志文件

程序运行时会生成以下日志文件，可用于问题诊断：

- `face_enhancement.log`：主要处理日志
- `skin_retouching.log`：皮肤美化处理日志
- `gui_enhancement.log`：图形界面操作日志

### 调试步骤

如果遇到问题，请按以下步骤进行调试：

1. 检查日志文件中的错误信息
2. 确认模型文件完整性
3. 验证Python环境和依赖包
4. 测试单张图片处理
5. 检查系统资源使用情况

## 注意事项

- **离线模式需要预先下载模型文件**
- **模型文件较大**（每个约几百MB），请确保有足够的存储空间
- **首次使用时，模型加载可能需要几秒钟时间**
- **人像增强修复功能对大尺寸图片会自动调整大小进行处理，然后恢复原始尺寸**
- **处理过程中会创建临时文件，请确保有足够的磁盘空间**
- **建议在处理大量图片前先测试单张图片的处理效果**

## 技术支持

如果在离线使用过程中遇到问题，可以：

1. 查看日志文件获取详细错误信息
2. 检查模型文件完整性
3. 确认系统环境配置
4. 联系技术支持：neilhostfr@gmail.com

---

**最后更新**：2025年3月14日
